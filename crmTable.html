<crmTable>
    <input type="button" value="Add entry" onClick="{addEntry}" />
    <input type="button" value="Clear filters" onClick="{clearFilter}" />
    <span>Tags</span>
    <select ref="tagFilter" id="tagFilter" multiple="multiple" onchange="{filter}">
        <option each={ tag in getTags()}>{tag}</option>
    </select>
    <span>Deadlines</span>
    <select ref="deadLineFilter" id="deadLineFilter" multiple="multiple" onchange="{filter}">
        <option each={ deadline in getDeadLines() }>{deadline}</option>
    </select>
    <span>Show only follow up project</span>
    <input type="checkbox" onClick={filterFollowUp} />
    <span>Selected tags</span>
    <ul>
        <li each={ tag in globalTags}>
            <span>Name:{tag.name}</span>
            Href:<input type="text" name="href" ref="href" value="{tag.href}" onChange="{updateTag(tag, 'href')}">
        </li>
    </ul>
    <script>
        updateTag(a, b){
            return function (event, c) {
                a[b] = event.target.value.trim();
                $.post("utils.php", { requestType: "writeTags", tags: JSON.stringify(tags) });
            }

        }

        filter() {
            var tags = $("#tagFilter").val();
            this.globalTags = tags.map(
                    e => {
                        if (globalTags.indexOf(e) >= 0)
                            return { name: e, href: JSON.parse(data).find(d => d.name == e).href };
                        return { name: e, href: "" }
                    }
                )
            if (tags.length != 0) {
                items.forEach(el => {
                    if (el.tags.some(t => tags.indexOf(t.name) >= 0) || el.tags.length == 0)
                        el.visible = true;
                     
                })
            }
            var deadlines = $("#deadLineFilter").val();
            if (deadlines.length != 0) {
                items.forEach(el => {
                    if (!el.tags.some(t => deadlines.some(d => new Date(t.deadline) <= new Date(d))))
                        el.visible = false;

                })
            }

            this.update();
        }

        clearFilter(){
            items.forEach(element => {
                element.visible = true;
            });
            this.update();
        }

        filterFollowUp(e){
            items.forEach(item => {
                if (e.target.checked == true && item.needsFollowUp == true)
                    item.visible = true;
                else if (e.target.checked == true && item.needsFollowUp == false)
                    item.visible = false;
                else
                    item.visible = true;
            });

            this.update;
        }
        addEntry(){
            var defaultItem = {
                id: getLastId(),
                tags: [],
                deadline: "",
                vendor: {
                    name: "",
                    phone: "",
                    contactName: "",
                    email: ""
                },
                call0: {
                    date: "",
                    time: "",
                    note: ""
                },
                bidding: true,
                bidded: false,
                needsFollowUp: false,
                calls: [
                    { date: "", time: "", note: "" },
                ],
                note: "",
                visible: true
            };

            if (JSON.stringify(opts.items[opts.items.length - 1]) === JSON.stringify(defaultItem)) return;
            else defaultItem.id++;
            opts.items.push(defaultItem);
            saveItems();
            this.update();
        }
        this.on("mount", () => {
            $.post("utils.php", { requestType: "read" }, (data) => {
                items = JSON.parse(data);

                $.post("utils.php", { requestType: "lastModified" }, (data) => {
                    lastModified = new Date(data);
                });
                this.update();
            });
        })
        tick() {
            $.post("utils.php", { requestType: "getTagHref" }, (data) => {
                globalTags = JSON.parse(data);
                this.update();
            });
            $.post("utils.php", { requestType: "lastModified" }, (data) => {
                modifiedDate = new Date(data);
                if (lastModified == undefined || !(modifiedDate.getTime() === lastModified.getTime())) {
                    $.post("utils.php", { requestType: "read" }, (data) => {
                        updatedItems = JSON.parse(data);
                        for (var i = 0; i < updatedItems.length; i++) {
                            if (i >= items.length) {
                                items.push(updatedItems[i]);
                            }
                            else {
                                Object.keys(items[i]).forEach(function (key) {
                                    items[i][key] = updatedItems[i][key];
                                });
                            }
                        }
                        console.log("Received changes")
                        this.update();
                    });
                    lastModified = modifiedDate;
                }
            });

        }

        var timer = setInterval(this.tick, 100)

    </script>
    <table class="table">
        <thead>
            <tr>
                <th scope="col">ID</th>
                <th scope="col">Project Tag</th>
                <th scope="col">Vendor</th>
                <th scope="col">Call 0</th>
                <th scope="col">Bidding</th>
                <th scope="col">Calls</th>
                <th scope="col">Needs Follow Up</th>
                <th scope="col">Bidded</th>
                <th scope="col">Note</th>
            </tr>
        </thead>
        <tbody>
            <tr each={ item in opts.items } if={item.visible}>
                <td>{item.id}</td>
                <td>
                    <tagInput tags={item.tags}/>
                </td>
                <td style="width:100px">
                    <input onChange="{updateValue(item.vendor, 'name')}" ref="vendorName" placeholder="Vendor Name" value={item.vendor.name}
                    />
                    <input onChange="{updateValue(item.vendor, 'phone')}" ref="vendorPhone" placeholder="Phone number" value={item.vendor.phone}
                    />
                    <input onChange="{updateValue(item.vendor, 'contactName')}" placeholder="Contract Name" value={item.vendor.contactName} />
                    <input onChange="{updateValue(item.vendor, 'email')}" placeholder="Email" value={item.vendor.email} />
                </td>
                <td style="width:100px">
                    <input onChange="{updateValue(item.call0, 'date')}" ref="call0date" placeholder="Call0 Name" value={item.call0.date} />
                    <input onChange="{updateValue(item.call0, 'time')}" type="time" placeholder="Call0 Time" value={item.call0.time} />
                    <textarea onChange="{updateValue(item.call0, 'note')}" placeholder="Call0 Note" value={item.call0.note} />
                </td>
                <td>
                    <center> <input onClick="{updateValue(item, 'bidding')}" type="checkbox" checked="{item.bidding}" </center>
                </td>

                <td>
                    <callColumn calls="{item.calls}" />
                </td>
                <td>
                    <center> <input onClick="{updateValue(item, 'needsFollowUp')}" type="checkbox" checked="{item.needsFollowUp}"
                            </center>
                </td>
                <td>
                    <center> <input onClick="{updateValue(item, 'bidded')}" type="checkbox" checked="{item.bidded}" </center>
                </td>
                <td>
                    <textarea onchange="{updateValue(item, 'note')}" value="{item.note}" />
                </td>

                <script>
                    updateValue(a, b){
                        return function (event, c) {
                            if (event.target.type == "checkbox") {
                                a[b] = event.target.checked;
                            } else {
                                a[b] = event.target.value.trim();
                            }
                            saveItems();
                        }
                        this.update();
                    }

                    this.on("mount", () => {
                        $(this.refs.date).datepicker();
                        $(this.refs.call0date).datepicker();
                    })

                    this.on("update", () => {
                        $(this.refs.inputTagDeadLine).datepicker();
                        $(this.refs.call0date).datepicker();
                    })
                </script>
            </tr>
        </tbody>
    </table>
</crmTable>


<tagInput>
    <ul width="150px">
        <li style="display: inline-block;" each={tag in opts.tags}>
            <tag val={ tag} remove={ ()=> remove(tag)} />
        </li>
    </ul>
    <input ref="inputTagName" placeholder="Tag Name" ref="input" />
    <input ref="inputTagDeadLine" placeholder="Tag Deadline" ref="input" />
    <center><input type="button" onClick={ add } value="ADD" /></center>

    <script>
        add(){
            var tagName = this.refs.inputTagName.value;
            var tagDeadline = this.refs.inputTagDeadLine.value;
            if (tagName != "" && this.opts.tags.map(t => t.name).indexOf(tagName) == -1)
                opts.tags.push({ name: tagName, deadline: tagDeadline });
            else
                alert("Tag already exists");
            this.update();
            saveItems();
        }
        remove(a){
            opts.tags.pop(a);
            this.update();
            saveItems();
        }

        this.on("mount", () => {
            $(this.refs.inputTags).autocomplete({
                source: getTags()
            });

            $(this.refs.inputTagDeadLine).datepicker();
        })

        this.on("update", () => {
            $(this.refs.inputTagDeadLine).datepicker();
        })
    </script>
</tagInput>

<tag>
    <span>{opts.val.name}</span>|<span>{opts.val.deadline}</span>
    <input type="button" value="X" onClick={opts.remove} />
</tag>

<callColumn>
    <ul style="width:400px;height:100px;overflow: scroll;">
        <li each={call in opts.calls}>
            <call val="{call}" remove="{()=>remove(call)}" />
        </li>
    </ul>
    <input type="button" onClick="{addCall}" value="Add call">
    <script>
        addCall(){
            opts.calls.push({});
            this.update();
            saveItems();
        }
        remove(call){
            opts.calls.pop(call);
            this.update();
            saveItems();
        }
    </script>
</callColumn>

<call>
    <input onChange="{updateValue(opts.val, 'date')}" ref="date" placeholder="Date" value="{this.opts.val.date}" />
    <input onChange="{updateValue(opts.val, 'time')}" type="time" placeholder="Time" value="{this.opts.val.time}" />
    <textarea onChange="{updateValue(opts.val, 'note')}" placeholder="Note" value="{this.opts.val.note}" />
    <input type="button" value="Delete Call" onclick="{opts.remove}" />
    <script>
        this.on('mount', function () {
            $(this.refs.date).datepicker({
                onSelect: function (data) {
                    $(this).get(0).dispatchEvent(new Event('change'));
                }
            });
        });

        updateValue(a, b){
            return function (event, c) {
                a[b] = event.target.value.trim();
                this.update();
                saveItems();
            }
        }
    </script>
</call>