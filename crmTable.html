<crmTable>
    <div class="fixed-top" style="background-color:#f4f4f4;">
        <div class="container-full" style="margin-left:30;margin-right: 30">
            <div class="row">
                <div class="col">
                    Project tag: <input class="form-control" ref="tags" id="tagFilter" placeholder="Tag Name" />
                </div>
                <div class="col">
                    Ending Before: <input class="form-control" ref="date" id="deadlineFilter" placeholder="Date">
                </div>
                <div class="col"></div>
                <div class="col">
                    Viewing:
                    <select class="custom-select" id="viewSelect" onChange={changeView}>
                        <option selected>CRM</option>
                        <option>Overview</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <span>Show only vendors needing follow up</span>
                    <input type="checkbox" onClick={filterFollowUp} />
                </div>
                <div class="col">
                </div>
                <div class="col">
                    <input type="button" class="btn btn-light" value="Clear filters" onClick="{clearFilter}" />
                </div>
                <div class="col">
                </div>
                <div class="col" style="text-align:right">
                    <button type="button" class="btn btn-light" onClick="{addEntry}">Add entry</button>
                    <button type="button" class="btn btn-light" data-toggle="modal" data-target="#addEntriesModal">Add multiple
                        entries
                    </button>
                </div>
            </div>
        </div>
    </div>
    <table class="table" style="margin-top: 200px" if="{globalView == 'CRM'}">
        <thead>
            <tr>
                <th scope="col">ID</th>
                <th scope="col">Project Tag</th>
                <th scope="col">Vendor</th>
                <th scope="col">Most recent call</th>
                <th scope="col">Needs Follow Up</th>
                <th scope="col">Intends to bid</th>
                <th scope="col">Bidded</th>
                <th scope="col">Previous calls</th>
            </tr>
        </thead>
        <tbody>
            <tr each={ item in globalInfo.items } if={item.visible}>
                <td style="text-align: center">{item.id}
                    <br>
                    <input type="button" class="btn btn-danger" value="Delete" onclick="{()=> deleteItem(item)}" /></td>
                <td>
                    <tagInput tags={item.tags} itemId={item.id} />
                </td>
                <td style="width:300">
                    <input class="form-control" onChange="{updateValue(item.vendor, 'name')}" ref="vendorName" placeholder="Vendor Name" value={item.vendor.name}
                    />
                    <input class="form-control" onChange="{updateValue(item.vendor, 'phone')}" ref="vendorPhone" placeholder="Phone number" value={item.vendor.phone}
                    />
                    <input class="form-control" onChange="{updateValue(item.vendor, 'contactName')}" placeholder="Contract Name" value={item.vendor.contactName}
                    />
                    <input class="form-control" onChange="{updateValue(item.vendor, 'email')}" placeholder="Email" value={item.vendor.email}
                    />
                </td>
                <td style="width:500px">
                    <input class="form-control" onChange="{updateValue(item.calls[item.calls.length - 1], 'date')}" ref="mostRecentCall" placeholder="Date"
                        value={item.calls[item.calls.length - 1].date} />
                    <input class="form-control" onChange="{updateValue(item.calls[item.calls.length - 1], 'time')}" type="time" placeholder="Time"
                        value={item.calls[item.calls.length - 1].time} />
                    <textarea class="form-control" onChange="{updateValue(item.calls[item.calls.length - 1], 'note')}" placeholder="Note" value={item.calls[item.calls.length
                        - 1].note} />
                    <input type="button" onClick="{() => addCall(item)}" value="Add call">
                </td>
                <td>
                    <center>
                        <input onClick="{updateValue(item, 'needsFollowUp')}" type="checkbox" checked="{item.needsFollowUp}" </center>
                </td>
                <td>
                    <center>
                        <input onClick="{updateValue(item, 'intendsToBid')}" type="checkbox" checked="{item.intendsToBid}" </center>
                </td>
                <td>
                    <center>
                        <input onClick="{updateValue(item, 'bidded')}" type="checkbox" checked="{item.bidded}" </center>
                </td>
                <td style="width:300px">
                    <callColumn calls="{item.calls}" />
                </td>
                <script>
                    updateValue(a, b){
                        return function (event, c) {
                            if (event.target.type == "checkbox") {
                                a[b] = event.target.checked;
                            } else {
                                a[b] = event.target.value.trim();
                            }
                            saveItems();
                        }
                        this.update();
                    }
                    addCall(item){
                        item.calls.push({ date: "", time: "", note: "" });
                        this.update();
                        saveItems();
                    }
                    hideItem(item){
                        item.visible = false;
                        this.update();
                    }

                    deleteItem(item){
                        var index = globalInfo.items.findIndex(x => x.id == item.id);
                        if (index != -1) {
                            globalInfo.items.splice(index, 1);
                        }
                        saveItems();
                    }

                    selectedTags = [];

                    filter(by) {
                        globalInfo.items.forEach(e => {
                            e.visible = true;
                        });
                        if (by == "tag") {
                            var tag = $("#tagFilter").val();
                            if (tag != "") {
                                globalInfo.items.forEach(el => {
                                    if (el.tags.find(t => getTag(t).name == tag) != undefined)
                                        el.visible = true;
                                    else
                                        el.visible = false;
                                })
                            }
                        } else if (by == "deadline") {
                            var deadline = $("#deadlineFilter").val();
                            globalInfo.items.forEach(el => {
                                if (el.tags.find(t => new Date(getTag(t).deadline).getTime() <= new Date(deadline).getTime()) != undefined)
                                    el.visible = true;
                                else
                                    el.visible = false;
                            })
                        }

                        this.update();
                    }

                    clearFilter(){
                        globalInfo.items.forEach(element => {
                            element.visible = true;
                        });
                        $(this.refs.date).val("");
                        $(this.refs.tags).val("");
                        this.update();
                    }

                    filterFollowUp(e){
                        this.clearFilter();
                        globalInfo.items.forEach(item => {
                            if (e.target.checked == true && item.needsFollowUp == true)
                                item.visible = true;
                            else if (e.target.checked == true && item.needsFollowUp == false)
                                item.visible = false;
                            else
                                item.visible = true;
                        });

                        this.update;
                    }
                    addEntry(){
                        var defaultItem = {
                            id: getLastId(),
                            tags: [],
                            deadline: "",
                            vendor: {
                                name: "",
                                phone: "",
                                contactName: "",
                                email: ""
                            },
                            intendsToBid: false,
                            bidded: false,
                            needsFollowUp: false,
                            calls: [
                                { date: "", time: "", note: "" },
                            ],
                            note: "",
                            visible: true
                        };

                        if (JSON.stringify(globalInfo.items[globalInfo.items.length - 1]) === JSON.stringify(defaultItem)) return;
                        else defaultItem.id++;
                        globalInfo.items.push(defaultItem);
                        saveItems();
                        this.update();
                    }
                    this.on("mount", () => {
                        $(this.refs.tags).on('keyup', (e) => this.filter('tag'));
                        $(this.refs.date).on('change', (e) => this.filter('deadline'));
                        $(this.refs.tags).autocomplete({
                            source: globalInfo.tags,
                            minLength: 0,
                            select: function (a, b) {
                                $(this).val(b.item.value);
                                $(this).keyup();
                            }
                        }).focus(function () {
                            $(this).keyup();
                            $(this).autocomplete('search', $(this).val())
                        });

                        $(this.refs.mostRecentCall).datepicker({
                            onSelect: function (data) {
                                $(this).get(0).dispatchEvent(new Event('change'));
                            }
                        });

                        $(this.refs.date).datepicker({
                            onSelect: function (data) {
                                $(this).val(data);
                                $(this).change();
                            }
                        });
                    })
                    this.on("update", () => {
                        $(this.refs.tags).autocomplete({
                            source: getTagsName()
                        });

                        $(this.refs.mostRecentCall).datepicker({
                            onSelect: function (data) {
                                $(this).get(0).dispatchEvent(new Event('change'));
                            }
                        });
                    })
                    tick() {
                        $.get("utils.php", { requestType: "lastModified", token: new Date().getTime() }, (data) => {
                            modifiedDate = new Date(data);
                            if (lastModified == undefined || !(modifiedDate.getTime() === lastModified.getTime())) {
                                $.get("utils.php", { requestType: "read", token: new Date().getTime() }, (data) => {
                                    updatedInfo = JSON.parse(data);
                                    globalInfo.tags = updatedInfo.tags;
                                    updatedItems = updatedInfo.items;
                                    var items = globalInfo.items;
                                    for (var i = 0; i < updatedItems.length; i++) {
                                        if (i >= items.length) {
                                            items.push(updatedItems[i]);
                                        } else {
                                            while (updatedItems[i].id != items[i].id) {
                                                items.splice(i, 1);
                                            }
                                            var visibility = items[i].visible;
                                            Object.keys(items[i]).forEach(function (key) {
                                                items[i][key] = updatedItems[i][key];
                                            });
                                            items[i].visible = visibility;
                                        }
                                    }
                                    console.log("Received changes")
                                    this.update();

                                    //Dirty trick to trigger datepicker after rendering of page
                                    $(this.refs.mostRecentCall).datepicker({
                                        onSelect: function (data) {
                                            $(this).get(0).dispatchEvent(new Event('change'));
                                        }
                                    });
                                    $("td:nth-child(2),td:nth-child(3), td:nth-child(4)")
                                        .css({
                                            position: "relative"
                                        })
                                        .prepend("<div class='resizer'></div>")
                                        .resizable({
                                            resizeHeight: false,
                                            handleSelector: "",
                                            onDragStart: function (e, $el, opt) {
                                                if (!$(e.target).hasClass("resizer"))
                                                    return false;
                                                return true;
                                            }
                                        });
                                });
                                lastModified = modifiedDate;
                            }
                        });

                    }
                    var timer = setInterval(this.tick, 100);

                    changeView(){
                        this.clearFilter();
                        var selectedView = $("#viewSelect").val();
                        globalView = selectedView;
                        this.update();
                    }
                </script>
            </tr>
        </tbody>
    </table>


    <table class="table" style="margin-top: 200px" if="{globalView == 'Overview'}">
        <thead>
            <tr>
                <th scope="col">Action</th>
                <th scope="col">Project Tag</th>
                <th scope="col">Bids</th>
                <th scope="col">Intending to bid</th>
            </tr>
        </thead>
        <tbody>
            <tr each={tag in globalInfo.tags}>
                <td style="width:150px;">
                    <button type="button" class="btn btn-dark">Archive</button>
                </td>
                <td>
                    <a href="{tag.href}">{tag.name}</a>|
                    <span>{tag.deadline}</span>
                </td>
                <td>
                    <a>{countBids(tag)}</a>
                    <ul class="list-group list-group-flush" style="max-height: 150px; overflow-y: scroll;">
                        <li class="list-group-item" each={vendor in getBids(tag)}>
                            <input class="form-control" value="{vendor.name}" readonly>
                        </li>
                    </ul>
                </td>
                <td>
                    <a>{countIntentions(tag)}</a>

                    <ul class="list-group list-group-flush" style="max-height: 150px; overflow-y: scroll;">
                        <li class="list-group-item" each={vendor in getIntentions(tag)}>
                            <input class="form-control" value="{vendor.name}" readonly>
                        </li>
                    </ul>
                </td>

                <script>
                    countBids(tag){
                        return globalInfo.items.filter(x => x.tags.find(t => JSON.stringify(getTag(t)) === JSON.stringify(tag) && x.bidded == true) != undefined).length;
                    }
                    getBids(tag){
                        return globalInfo.items.filter(x => x.tags.find(t => JSON.stringify(getTag(t)) === JSON.stringify(tag) && x.bidded == true) != undefined).map(x => x.vendor);
                    }
                    countIntentions(tag){
                        return globalInfo.items.filter(x => x.tags.find(t => JSON.stringify(getTag(t)) === JSON.stringify(tag) && x.intendsToBid == true) != undefined).length;
                    }
                    getIntentions(tag){
                        return globalInfo.items.filter(x => x.tags.find(t => JSON.stringify(getTag(t)) === JSON.stringify(tag) && x.intendsToBid == true) != undefined).map(x => x.vendor);
                    }
                </script>
            </tr>
        </tbody>


    </table>
    <div class="modal" id="addEntriesModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add multiple entries</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Fields:
                    <select id="fields">
                        <option value="vendor.name">Vendor Name</option>
                        <option value="vendor.phone">Vendor Phone Number</option>
                        <option value="vendor.contactName">Vendor Contact Name</option>
                        <option value="vendor.email">Vendor Email</option>
                        <option value="call0.date">Call0 Date</option>
                        <option value="call0.time">Call0 Time</option>
                        <option value="call0.note">Call0 Note</option>
                        <option value="note">Note</option>
                    </select>
                    <input type="button" value="Add" onClick="{addField}" />
                    <ul>
                        <li each={field in this.selectedEntryFields}>
                            {field}
                            <input type="button" class="btn btn-light" value="X" onClick="{()=> removeField(field)}" />
                        </li>
                    </ul>
                    Values:
                    <textarea class="form-control" id="inputFields" style="width:100%"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onClick="{import}">Add</button>
                    <button type="button" class="btn" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="addTagModal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input id="addTagModalName" class="form-control" placeholder="Project Name">
                    <input id="addTagModalDeadline" class="form-control" placeholder="Deadline">
                    <input id="addTagModalHref" class="form-control" placeholder="HREF">
                </div>
                <div class="modal-footer">
                    <button id="submit" type="button" class="btn btn-primary" onClick={createTag}>Create</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editTagModal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input id="editTagModalName" class="form-control" placeholder="Project Name">
                    <input id="editTagModalDeadline" class="form-control" placeholder="Deadline">
                    <input id="editTagModalHref" class="form-control" placeholder="HREF">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger mr-auto" onclick="{deleteTag}">Delete</button>
                    <button id="submit" type="button" data-dismiss="modal" class="btn btn-primary" onClick={editTag}>Edit</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        this.selectedEntryFields = [];

        addField(){
            var selectedField = $("#fields").val();
            if (this.selectedEntryFields.indexOf(selectedField) == -1)
                this.selectedEntryFields.push(selectedField);
        }

        removeField(field){
            this.selectedEntryFields.pop(field);
            this.update();
        }

        import(){
            var input = $("#inputFields").val();
            input = input.split("\n").map(i => i.trim("	 ").split("\t")).filter(i => i.length != 0 || i.every(e => e == ""));

            input.forEach(e => {
                var defaultItem = {
                    id: getLastId() + 1,
                    tags: [],
                    deadline: "",
                    vendor: {
                        name: "",
                        phone: "",
                        contactName: "",
                        email: ""
                    },
                    call0: {
                        date: "",
                        time: "",
                        note: ""
                    },
                    bidded: false,
                    intendsToBid: false,
                    needsFollowUp: false,
                    calls: [
                        { date: "", time: "", note: "" },
                    ],
                    note: "",
                    visible: true
                };
                for (var i = 0; i < this.selectedEntryFields.length; i++) {
                    var p = this.selectedEntryFields[i].split(".")[0];
                    var p2 = this.selectedEntryFields[i].split(".")[1];
                    defaultItem[p][p2] = e[i];
                }
                defaultItem.id = getLastId() + 1;
                globalInfo.items.push(defaultItem);

            });
            saveItems();
            this.update();
        }
        createTag(){
            var id = new Date().getTime();
            var name = $("#addTagModalName").val();
            var deadline = $("#addTagModalDeadline").val();
            var href = $("#addTagModalHref").val();
            var archived = false;
            if (href.indexOf("http://") != 0) href = "http://" + href;
            
            if(getTagWithName(name) != undefined){
                alert(`Tag with name ${name} already exists`);
                return;
            }

            globalInfo.tags[id] = { name: name, deadline: deadline, href: href, archived: archived };
            var item = globalInfo.items.find(x => x.id == currentUsedItem);
            item.tags.push(id);
          
            $('#addTagModal').modal('toggle');

            saveItems();
            this.update();
        }
        editTag(){
            var name = $("#editTagModalName").val();
            var deadline = $("#editTagModalDeadline").val();
            var href = $("#editTagModalHref").val();

            globalInfo.tags[currentUsedItem] = { name: name, deadline: deadline, href: href };
            saveItems();
            this.update();
        }

        deleteTag(){
            var answer = confirm("Are you sure you want to delete this?");
            if (answer) {
                $('#editTagModal').modal('toggle');
                globalInfo.items.forEach(e => {
                    var tagIndex = e.tags.findIndex(x => x == currentUsedItem);
                    if (tagIndex >= 0)
                        e.tags.splice(tagIndex, 1);
                });
            }
            saveItems();
        }
    </script>
</crmTable>

<tagInput>
    <div class="dropdown" style="text-align:center">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true"
            aria-expanded="false">
            Add tag
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <a class="dropdown-item" onClick="{createTag}">Create New +</a>
            <a class="dropdown-item" each={tag, index in globalInfo.tags} onclick="{()=> add(index)}">{tag.name}</a>
        </div>
    </div>
    <ul class="list-group list-group-flush" style="max-height: 150px; overflow-y: scroll;" width="150px">
        <li class="list-group-item" each={tag in opts.tags}>
            <tag val={getTag(tag)} index={tag} remove={ ()=> remove(tag)} />
        </li>
    </ul>

    <script>
        add(tagIndex){
            if (this.opts.tags.indexOf(tagIndex) == -1)
                opts.tags.push(tagIndex);
            else
                alert("Tag already exists");
            this.update();
            saveItems();
        }
        createTag(){
            $("#addTagModalName").val('');
            $("#addTagModalDeadline").datepicker();
            $("#addTagModalDeadline").val('');
            $("#addTagModalHref").val('');
            currentUsedItem = this.opts.itemid;
            $("#addTagModal").modal();
        }

        remove(a){
            var index = opts.tags.findIndex(x => x == a);
            if (index > -1)
                opts.tags.splice(index, 1);
            this.update();
            saveItems();
        }

        this.on("mount", () => {
            $(this.refs.inputTagName).autocomplete({
                source: globalInfo.tags
            });

            $(this.refs.inputTagDeadLine).datepicker();
        })

        this.on("update", () => {
            $(this.refs.inputTagName).autocomplete({
                source: globalInfo.tags
            });
            $(this.refs.inputTagDeadLine).datepicker();
        })
    </script>
</tagInput>

<tag>
    <button class="btn btn-light" onclick="{editTag}" if={!opts.val.archived}><i class="far fa-edit"></i></button>
    <input class="btn btn-light" type="button" value="X" onClick={opts.remove} />
    <a href="{opts.val.href}">{opts.val.name}</a>|
    <span>{opts.val.deadline}</span>

    <script>
        editTag(){
            var tag = getTag(this.opts.index);
            $("#editTagModalName").val(tag.name);
            $("#editTagModalDeadline").datepicker();
            $('#editTagModalDeadline').datepicker("setDate", new Date(tag.date));
            $("#editTagModalHref").val(tag.href);
            currentUsedItem = this.opts.index;
            $("#editTagModal").modal();
        }
    </script>
</tag>

<callColumn>
    <ul class="list-group list-group-flush" style="max-height: 150px; overflow-y: scroll;">
        <li class="list-group-item" each={call, index in opts.calls}>
            <call val="{call}" if={index !=opts.calls.length-1} remove="{()=>remove(call)}" />
        </li>
    </ul>

    <script>
        remove(call){
            var index = opts.calls.findIndex(x => x.date == call.date && x.time == call.time && x.note == call.note);
            if (index > -1)
                opts.calls.splice(index, 1);
            this.update();
            saveItems();
        }
    </script>
</callColumn>

<call>
    <input class="form-control" onChange="{updateValue(opts.val, 'date')}" ref="date" placeholder="Date" value="{this.opts.val.date}"
    />
    <input class="form-control" onChange="{updateValue(opts.val, 'time')}" type="time" placeholder="Time" value="{this.opts.val.time}"
    />
    <textarea class="form-control" onChange="{updateValue(opts.val, 'note')}" placeholder="Note" value="{this.opts.val.note}"
    />
    <input type="button" class="btn btn-danger" value="Delete Call" onclick="{opts.remove}" />
    <script>
        this.on('mount', function () {
            $(this.refs.date).datepicker({
                onSelect: function (data) {
                    $(this).get(0).dispatchEvent(new Event('change'));
                }
            });
        });

        updateValue(a, b){
            return function (event, c) {
                a[b] = event.target.value.trim();
                this.update();
                saveItems();
            }
        }
    </script>
</call>